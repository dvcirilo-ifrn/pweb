---
theme: default
size: 4:3
marp: true
paginate: true
_paginate: false
title: Aula 08: Models
author: Diego Cirilo

---
<style>
img {
  display: block;
  margin: 0 auto;
}
</style>

# <!-- fit --> Programa√ß√£o de Sistemas para Internet

### Prof. Diego Cirilo

**Aula 08**: Models

---
# Dados do sistema
- Como armazenar os dados do sistema?
- Conte√∫do, dados de usu√°rio, etc.;
- SGBD - Sistema de Gerenciamento de Banco de Dados;
- SQL - *Structured Query Language*.

---
# ORM
- Gerenciar comandos SQL pode ser complicado;
- ORM - *Object Relational Mapping*;
- Podemos tratar os dados do BD como objetos.

---
# Models Django
- No Django o ORM √© feito nos *Models* (`models.py`);
- Nele definimos os modelos de dados, seus campos e comportamento;
- Cada modelo √© uma classe Python que herda de `django.db.models.Model`;
- Cada atributo de um model representa um campo no BD;
- O Django se responsabiliza por gerenciar as tabelas, *queries*, etc.;
- O Django tamb√©m cria campos automaticamente, como ID.

---
# Exemplo
```py
from django.db import models

class Pessoa(models.Model):
    nome = models.CharField(max_length=30)
    sobrenome = models.CharField(max_length=30)
```
```sql
CREATE TABLE myapp_pessoa (
    "id" bigint NOT NULL PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    "nome" varchar(30) NOT NULL,
    "sobrenome" varchar(30) NOT NULL
);
```

---
# Alguns tipos de dados

- CharField: Textos curtos (nomes, t√≠tulos);
- TextField: Textos longos (descri√ß√µes, artigos);
- IntegerField: N√∫meros inteiros (idades, quantidades);
- FloatField: N√∫meros decimais (pre√ßos, m√©dias);
- BooleanField: Valores booleanos (Verdadeiro/Falso);
- DateField: Datas (anivers√°rios, datas de cria√ß√£o);
- DateTimeField: Datas e horas (eventos, logs);
- [Refer√™ncia](https://docs.djangoproject.com/pt-br/5.1/ref/models/fields/#model-field-types).

---
# Alguns tipos de dados

- EmailField: Endere√ßos de e-mail (valida√ß√£o autom√°tica);
- FileField: Arquivos;
- ImageField: Imagens;
- ForeignKey: Relacionamentos um-para-muitos;
- ManyToManyField: Relacionamentos muitos-para-muitos;
- OneToOneField: Relacionamentos um-para-um;
- [Refer√™ncia](https://docs.djangoproject.com/pt-br/5.1/ref/models/fields/#model-field-types).

---
# Alguns atributos dos campos
- `max_length` - tamanho m√°ximo para texto;
- `null` - se vazio usa o `NULL` do SGBD;
- `blank` - o campo pode ser vazio se `True`, por padr√£o √© `False`;
- `default` - valor padr√£o;
- `unique` - se `True` o valor deve ser √∫nico na tabela;
- `choices` - lista de valores poss√≠veis.

---
# *FileField* e *ImageField*
- Sobem arquivos para uma pasta no servidor;
- Seguran√ßa!
- No BD fica salvo o endere√ßo o arquivo;
- Para *ImageField* √© necess√°rio instalar o pacote `pillow`;
- Os arquivos s√£o salvos na pasta configurada em `MEDIA_ROOT`;
- O link para acesso aos arquivos fica configurado em `MEDIA_URL`;

---
# *FileField* e *ImageField*
- Esses diret√≥rios n√£o s√£o configurados por padr√£o;
- Devemos adicionar no `settings.py`:
```python
MEDIA_URL = "media/"
MEDIA_ROOT = BASE_DIR / "media"
```

---
# *FileField* e *ImageField*
- No `urls.py` (apenas durante o desenvolvimento!):
```python
# adicionar no inicio do arquivo:
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    ..., # importante acabar com v√≠rgula!
]
# concatena a lista acima com o resultado de static()
urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
```

---
# *FileField* e *ImageField*
- Atributo `upload_to`:
    - diret√≥rio dentro de `MEDIA_ROOT`;
    - permite organizar melhor os arquivos;
```python
class Perfil(models.Model):
    documento = FileField(upload_to="documentos/")
    avatar = ImageField(upload_to="avatars/")
```

---
# Relacionamentos
- Relacionam modelos;
- Recebem como argumentos o nome da classe relacionada;
- ForeignKey: chave estrangeira (um-para-v√°rios);
- ManyToManyField: muitos-para-muitos;
- OneToOneField: um-para-um.

---
# Relacionamentos
- `on_delete` - define o que ocorre quando o objeto √© removido;
- `on_delete=models.CASCADE` - deleta os objetos relacionados junto;
- `on_delete=models.SET_NULL` - escreve `NULL`;
- `on_delete=models.PROTECT` - impede a remo√ß√£o enquanto houver dados relacionados;
- [Refer√™ncia](https://docs.djangoproject.com/pt-br/5.1/ref/models/fields/#django.db.models.ForeignKey.on_delete).

---
# Exemplos
- Um pra um:
```python
class Pessoa(models.Model):
    nome = models.CharField(max_length=100)
    cpf = models.CharField(max_length=11, unique=True)

class DadosPessoais(models.Model):
    pessoa = models.OneToOneField(Pessoa, on_delete=models.CASCADE)
    data_nascimento = models.DateField()
```

---
# Exemplos
- Um pra v√°rios:
```python
class Pessoa(models.Model):
    nome = models.CharField(max_length=100)
    cpf = models.CharField(max_length=11, unique=True)

class Veiculo(models.Model):
    pessoa = models.ForeignKey(Pessoa, on_delete=models.PROTECT)
    placa = models.CharField(max_length=7)
    modelo = models.CharField(max_length=50)
```

---
# Exemplos
- V√°rios pra v√°rios:
```python
class Pessoa(models.Model):
    nome = models.CharField(max_length=100)
    cpf = models.CharField(max_length=11, unique=True)

class Empresa(models.Model):
    socios = models.ManyToManyField(Pessoa)
    nome = models.CharField(max_length=50)
    cnpj = models.CharField(max_length=14, unique=True)
```

---
# Exemplos
- V√°rios pra v√°rios (com tabela intermedi√°ria):
```python
class Pessoa(models.Model):
    nome = models.CharField(max_length=100)
    cpf = models.CharField(max_length=11, unique=True)

class Empresa(models.Model):
    socios = models.ManyToManyField(Pessoa, through="Socio")
    nome = models.CharField(max_length=50)
    cnpj = models.CharField(max_length=14, unique=True)

class Socio(models.Model):
    pessoa = ForeignKey(Pessoa, on_delete=models.CASCADE)
    empresa = ForeignKey(Pessoa, on_delete=models.CASCADE)
    data_entrada = DateField() # campos extras
    data_saida = DateField() # campos extras
```

---
# Choices
<style scoped>pre { font-size: 18px; }</style>
- Lista de valores que um campo pode assumir;
- Valida√ß√£o autom√°tica e consist√™ncia;
```python
class Usuario(models.Model):
    ALUNO = "AL"
    PROFESSOR = "PR"
    MONITOR = "MO"
    TIPOS = {
        ALUNO: "Aluno",
        PROFESSOR: "Professor",
        MONITOR: "Monitor",
    }

    nome = models.CharField(max_length=100)
    tipo = models.CharField(max_length=2, choices=TIPOS, default=ALUNO)
```

---
# Choices
- √â poss√≠vel acessar com `Usuario.ALUNO`, etc;
- Ex.
```python
from .models import Usuario
...
if usuario.tipo == Usuario.ALUNO:
    print("O usu√°rio √© aluno.")
```

---
# Classe Meta
- Subclasse que permite algumas informa√ß√µes extras;
- Ex.
    - `verbose_name`
    - `verbose_name_plural`
    - `ordering`
-[Refer√™ncia](https://docs.djangoproject.com/en/5.1/ref/models/options/#model-meta-options)

---
<style scoped>section { font-size: 26px; }</style>
# M√©todos
- Como qualquer classe, √© poss√≠vel adicionar m√©todos aos models;
- Esses m√©todos podem tratar dados, retornar informa√ß√µes processadas, etc;
- Ex.: um m√©todo que retorna o `nome_completo` a partir dos campos `nome` e `sobrenome`;
- Existem alguns m√©todos padr√£o que tamb√©m √© poss√≠vel sobrescrever;
- Ex. `__str__` retorna a string que ser√° impressa quando fazemos um `print` em um objeto dessa classe;
- Para m√©todos que funcionem como atributos (sem precisar chamar com `()`) usamos o *decorator* `@property`.

---
# M√©todos
- Ex.:
```python
class Pessoa(models.Model):
    nome = models.CharField(max_length=100)
    sobrenome = models.CharField(max_length=100)

    class Meta:
        ordering = ["sobrenome"] # retorna os resultados ordenados pelo sobrenome

    def __str__(self):
        return self.nome

    @property
    def nome_completo(self):
        return f"{self.nome} {self.sobrenome}"

```

---
# Acessando dados dos Models
- A *view* √© respons√°vel por acessar os dados;
- √â poss√≠vel fazer *queries* atrav√©s do objeto do Model:
    - `Model.objects.all()` - retorna *tudo*;
    - `Model.objects.filter()` - permite *filtrar* os dados;
    - `Model.objects.get(pk=4)` - seleciona um objeto espec√≠fico;
- Retornam `QuerySets`;
- Os resultados podem ser enviados para o template no `context`.

---
# Filter
- Parecido com `WHERE` do SQL;
- Padr√£o:
    - `campo__condicao=valor`
- Ex. alunos com menos de 18 anos:
    - `Alunos.objects.filter(idade__lte=18)`

---
# Filter Lookups
- `exact` - valor tem que ser exato;
- `iexact` - exato mas *case-insensitive*;
- `contains` - cont√©m o valor;
- `startswith` - come√ßa com;
- `endswith` - termina com;
- [Refer√™ncia](https://docs.djangoproject.com/en/5.1/ref/models/querysets/#field-lookups).

---
# *Shortcuts*
- O Django disponibiliza alguns atalhos;
- J√° usamos o `render` e o `redirect`
- Para acesso aos models existem os:
    - `get_object_or_404()`
    - `get_list_or_404()`
- Podemos passar um Model e uma query, se n√£o houver resposta, o sistema redireciona para a p√°gina de erro 404;
- [Refer√™ncia](https://docs.djangoproject.com/en/5.1/topics/http/shortcuts/#module-django.shortcuts).

---
# Exemplos
- views.py:
```python
from django.shortcuts import render, get_object_or_404, get_list_or_404
from .models import Livro

def detalhar_livro(request, id_do_livro):
    livro = get_object_or_404(Livro, id=id_do_livro)
    context = {
        'livro': livro,
    }
    return render(request, "detalhar_livro.html", context)

def listar_livros(request):
    livros = get_list_or_404(Livro)
    context = {
        'livros': livros,
    }
    return render(request, "listar_livros.html", context)
```

---
# Exemplos
- Tamb√©m √© poss√≠vel filtrar diretamente ou usar QuerySets:
```python
...
livros_com_M = get_list_or_404(Livro, titulo__startswith="M")

livros_com_N = Livros.objects.filter(titulo__startswith="N") #queryset
livros_com_N_do_autor1 = get_object_or_404(livros_com_N, autor=1)
...
```

---
# Configura√ß√µes do BD
- No arquivo `settings.py` h√° a se√ß√£o `DATABASES`;
- Podemos configurar diversos SGBDs;
- Ex. MySQL, PostGres, SQLite, etc.;
- Para desenvolvimento o SQLite √© simples e exige menos configura√ß√£o;
- No sistema final devemos usar um SGBD mais completo (veremos em ICS).

---
# Configura√ß√µes de BD

```
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}
```

---
# Migrations
- Arquivo com comandos para o SGBD;
- Permite recriar a estrutura (*schema*) do BD em qualquer computador;
- Novas migra√ß√µes devem ser criadas sempre que alteramos os dados em Models:
    - `python manage.py makemigrations`
- Para **aplicar** as *migrations*, ou seja, criar/alterar as tabelas no SGBD:
    - `python manage.py migrate`
- √â importante sempre lembrar de criar/aplicar as migrations.

---
# Fixtures
- As *fixtures* permitem popular o banco de dados com dados iniciais;
- S√£o √∫teis para testes, prot√≥tipos e replica√ß√£o de ambientes;
- S√£o arquivos em formatos como JSON, XML ou YAML contendo registros dos models;
- S√£o criadas e carregadas pelos comandos:
```
python manage.py dumpdata > dados.json
python manage.py loaddata dados.json
```

---
# Fixtures
- √â poss√≠vel exportar apenas apps espec√≠ficos:
```
python manage.py dumpdata minha_app > dados.json
```
- Tamb√©m podemos exportar apenas determinados models:
```
python manage.py dumpdata minha_app.Modelo > dados.json
```

---
# Fixtures
- Para evitar conflitos comuns com apps do Django, use o par√¢metro `--exclude`:
```
python manage.py dumpdata --exclude auth.permission --exclude contenttypes --exclude admin.logentry --exclude sessions > dados.json
```
- Isso exclui dados de apps padr√£o que geralmente causam erros ao usar `loaddata`;
- Recomendado exportar apenas os dados criados na sua aplica√ß√£o.

---
# Django Shell
- O Django possui um terminal interativo com acesso ao ambiente do projeto:
```
python manage.py shell
```
- √â poss√≠vel importar os models e interagir com o banco de dados;
- Exemplo:
```python
from minha_app.models import Pessoa
Pessoa.objects.all()
```

---
# Criando, Salvando e Editando Objetos
- Criar e salvar um objeto:
```python
from minha_app.models import Pessoa
p = Pessoa(nome="Jo√£o", sobrenome="Silva")
p.save()
```

- Criar diretamente:
```python
Pessoa.objects.create(nome="Maria", sobrenome="Oliveira")
```

---
# Criando, Salvando e Editando Objetos
- Editar:
```python
p = Pessoa.objects.get(id=1)
p.nome = "Jos√©"
p.save()
```
- Excluir:
```python
p.delete()
```
- Consultar:
```python
Pessoa.objects.filter(sobrenome="Silva")
```

---
# Django Admin
- O Django foi pensado para facilitar o processo de desenvolvimento;
- Um projeto Django j√° possui uma interface de administra√ß√£o pronta;
- Para ativar, temos que:
    - Adicionar os models ao arquivo `admin.py`;
    - Criar um *superuser* do sistema;
    - Executar as *migrations*.

---
# Django Admin
```
from django.contrib import admin

from .models import Tarefa

admin.site.register(Tarefa)
```

---
# Django Admin
- Para criar o *superuser*:
    - `python manage.py createsuperuser`
- Para criar as *migrations*:
    - `python manage.py makemigrations`
- Para executar as *migrations*:
    - `python manage.py migrate`

---
# Django Admin
- Para configurar a l√≠ngua do sistema (incluindo o *admin*):
    - Altere `LANGUAGE_CODE` no `settings.py` para `pt-br`
- Na listagem de tarefas aparece `Tarefas object(1)`, esse √© o resultado do `print` em um objeto da classe `Tarefas`
- Para imprimir algo mais interessante, escrevemos o m√©todo `__str__` para a classe `Tarefas`

```py
def __str__(self):
    return self.nome
```

---
# Tarefa 04
- Crie um site simples de lista de tarefas;
- Cada tarefa deve ter: nome, status e prazo; (Model)
- O cadastro das tarefas deve ser feito pelo Django Admin;
- Diferencie as tarefas que est√£o atrasadas;
    - Dica: use a biblioteca `datetime` do Python na view para passar a data atual no `context`:
```
from datetime import date

...
context['hoje'] = date.today()

```

---
# Tarefa 05
- Crie um blog simples com duas views:
    - index: lista de todos os posts com t√≠tulo, data e link da postagem;
    - post/<id>: p√°gina com o conte√∫do do post
- O blog deve ter um *header* com o t√≠tulo e link para o index, e um *footer* com informa√ß√µes do desenvolvedor;
- O conte√∫do de cada postagem deve ser apenas uma imagem, um t√≠tulo, o texto e a data de publica√ß√£o;
- Todas essas informa√ß√µes devem existir no BD;
- Crie um *superuser* e cadastre as postagens pela p√°gina de *admin*.

---
# Projeto 02
- Converta o Projeto 01 em um sistema din√¢mico, usando os Models;
- Crie os Models para cada um dos dicion√°rios que voc√™ usou nas *views*;
- Adicione esses models no Django Admin e cadastre todos os dados por l√°;
- O site deve funcionar do mesmo jeito do anterior (ou melhor!).

---
# <!--fit--> D√∫vidas? ü§î
